name: PR Checks

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  validate:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Use Node.js 20.x
      uses: actions/setup-node@v4
      with:
        node-version: 20.x
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Check package.json validity
      run: npm pkg fix --dry-run
      
    - name: Validate TypeScript configuration
      run: npx tsc --noEmit
      
    - name: Run tests
      run: npm test
      
    - name: Build package
      run: npm run build
      
    - name: Verify package contents
      run: |
        npm pack --dry-run
        echo "Package size:"
        npm pack --dry-run 2>/dev/null | grep -o '[0-9.]*[kM]B'
        
    - name: Check for breaking changes
      run: |
        if [ -f "./dist/index.d.ts" ]; then
          echo "‚úÖ TypeScript declarations generated"
        else
          echo "‚ùå Missing TypeScript declarations"
          exit 1
        fi
        
    - name: Security audit
      run: npm audit --audit-level=moderate
      
  size-check:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Use Node.js 20.x
      uses: actions/setup-node@v4
      with:
        node-version: 20.x
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Build package
      run: npm run build
      
    - name: Check bundle size
      run: |
        npm pack --silent
        SIZE=$(du -h discussing-*.tgz | cut -f1)
        echo "üì¶ Package size: $SIZE"
        
        # Alert if package is larger than 100KB
        SIZE_BYTES=$(du -b discussing-*.tgz | cut -f1)
        if [ $SIZE_BYTES -gt 102400 ]; then
          echo "‚ö†Ô∏è  Package size ($SIZE) is larger than 100KB"
        else
          echo "‚úÖ Package size is acceptable"
        fi