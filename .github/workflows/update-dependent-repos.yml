name: Update Dependent Repositories

on:
  release:
    types: [published]

jobs:
  update-cofe:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
      pull-requests: write
      
    steps:
    - name: Extract version from tag
      id: version
      run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
      
    - name: Checkout Cofe repository
      uses: actions/checkout@v4
      with:
        repository: metrue/Cofe
        token: ${{ secrets.COFE_UPDATE_TOKEN || secrets.GITHUB_TOKEN }}
        
    - name: Use Node.js 20.x
      uses: actions/setup-node@v4
      with:
        node-version: 20.x
        cache: 'npm'
        
    - name: Configure Git
      run: |
        git config user.name "discussing-bot[bot]"
        git config user.email "discussing-bot[bot]@users.noreply.github.com"
        
    - name: Create update branch
      run: |
        BRANCH_NAME="automated/update-discussing-v${{ steps.version.outputs.VERSION }}"
        git checkout -b "$BRANCH_NAME"
        echo "BRANCH_NAME=$BRANCH_NAME" >> $GITHUB_ENV
        
    - name: Download new package version
      run: |
        # Remove old package if it exists
        rm -f discussing-*.tgz
        
        # Download new version from npm
        npm pack discussing@${{ steps.version.outputs.VERSION }}
        
    - name: Update package.json dependency
      run: |
        # Update the file path reference in package.json
        PACKAGE_FILE="discussing-${{ steps.version.outputs.VERSION }}.tgz"
        
        # Update package.json to reference new tarball
        if [ -f package.json ]; then
          sed -i 's|"discussing": "file:./discussing-[^"]*"|"discussing": "file:./'$PACKAGE_FILE'"|' package.json
        fi
        
    - name: Install and test updated package
      run: |
        npm install
        npm test || echo "Tests failed, but continuing with update"
        
    - name: Commit changes
      run: |
        git add .
        if ! git diff --staged --quiet; then
          git commit -m "chore: update discussing package to v${{ steps.version.outputs.VERSION }}
          
          - Updated discussing dependency to v${{ steps.version.outputs.VERSION }}
          - Package downloaded from npm registry
          - Automated update from discussing package release
          
          ğŸ¤– Automated update by discussing-bot"
          
          git push origin "$BRANCH_NAME"
        else
          echo "No changes to commit"
          exit 0
        fi
        
    - name: Create Pull Request
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.COFE_UPDATE_TOKEN || secrets.GITHUB_TOKEN }}
        script: |
          const { data: pr } = await github.rest.pulls.create({
            owner: 'metrue',
            repo: 'Cofe',
            title: `chore: update discussing package to v${{ steps.version.outputs.VERSION }}`,
            head: process.env.BRANCH_NAME,
            base: 'main',
            body: `## ğŸ“¦ Automated Package Update
            
            This PR updates the \`discussing\` package to version **v${{ steps.version.outputs.VERSION }}**.
            
            ### Changes
            - â¬†ï¸ Updated discussing dependency to v${{ steps.version.outputs.VERSION }}
            - ğŸ“¦ Package downloaded from npm registry
            - ğŸ”„ Automated update triggered by discussing package release
            
            ### What to do
            - âœ… Review the changes
            - âœ… Test the updated functionality  
            - âœ… Merge when ready
            
            ### Links
            - ğŸ”— [Release Notes](https://github.com/metrue/discussing/releases/tag/v${{ steps.version.outputs.VERSION }})
            - ğŸ“‹ [Discussing Package](https://www.npmjs.com/package/discussing/v/${{ steps.version.outputs.VERSION }})
            
            ---
            ğŸ¤– This PR was created automatically by the discussing package release workflow.`
          });
          
          console.log(`Created PR #${pr.number}: ${pr.html_url}`);